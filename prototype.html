<!DOCTYPE html>
<head>
<meta charset="utf-8">
<!-- <link rel="stylesheet" href="css/prototype.css"> -->
<style>
/************************************************************/
/******************** PROTOTYPE CANVAS **********************/
/************************************************************/
path,
line {
  shape-rendering: crispEdges;
}
body{
  font-family: "Avenir", "Lato";
}


canvas {
  position: absolute;
top: 30px;
    left: 9px;
}

svg {
  pointer-events: none;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
}

circle {
  stroke-width: 4px;
  stroke: #fdbf11;
  fill: #fdbf11;
}

.hidden {
  display: none;
}


#controls{
  display: block;
}
.controlContainer{
  display: inline-block;
  margin-right: 40px;
  margin-top: 20px;
}

div.tempHighlight{
  background: #fdbf11;
}

#revdisp{
  font-weight: bold;
  position: fixed;
    top: 10px;
    left: 796px;
}
#incdisp{
  font-weight: bold;
  position: fixed;
    top: 40px;
    left: 796px;
}

.axisLable{
  position: fixed;
  font-size: 12px;
  font-style: italic;
  top: 100px;
  left: 100px; 
}
.incLabel{
top: 26px;
    left: 370px;
}
.revLabel{
  top: 190px;
  left: 49px;
}

</style>
</head>
<body>

<select id = "groupMenu">
<option value = "a">all</option>
<option value = "b">elderly</option>
<option value = "c">head of household</option>
<option value = "d">with kids</option>
<option value = "e">married filing jointly</option>
<option value = "f">married filing separatly</option>
<option value = "g">married with kids</option>
<option value = "h">married with minor kids</option>
<option value = "i">married with young kids</option>
<option value = "j">no kids</option>
<option value = "k">not elderly</option>
<option value = "l">single</option>
</select>

<select id = "incomeMenu">
<option value = "1">1st quintile</option>
<option value = "2">2nd quintile</option>
<option value = "3">3rd quintile</option>
<option value = "4">4th quintile</option>
<option value = "5">5th quintile</option>
<option value = "6">top 10%</option>
<option value = "7">top 5%</option>
<option value = "8">top 1%</option>
<option value = "9">top 0.5%</option>
<option value = "0">all</option>
</select>


<div class = "revLabel axisLable">Adjusted revenue</div>
<div class = "incLabel axisLable">Change in after tax income</div>
<div id = "revdisp">Adjusted revenue: <span></span></div>
<div id = "incdisp">Change in after tax income: <span></span></div>

<div id = "chartContainer"></div>

<div id = "controls">
  <div class = "controlContainer">
    <div>Marginal rates</div>
    <div><input class = "rates a control" type="checkbox" value="a" checked="checked"><span>Pre TCJA</span></div>
    <div><input class = "rates e control" type="checkbox" value="e" checked="checked"><span>Midway</span></div>
    <div><input class = "rates b control" type="checkbox" value="b" checked="checked"><span>TCJA</span></div>
    <div><input class = "rates c control" type="checkbox" value="c" checked="checked"><span>High</span></div>
    <div><input class = "rates d control" type="checkbox" value="d" checked="checked"><span>Higher</span></div>
  </div>

  <div class = "controlContainer">
    <div>Standard deductions</div>
    <div><input class = "standard l control" type="checkbox" value="l" checked="checked"><span>Low</span></div>
    <div><input class = "standard ml control" type="checkbox" value="ml" checked="checked"><span>Medium low</span></div>
    <div><input class = "standard mh control" type="checkbox" value="mh" checked="checked"><span>Medium high</span></div>
    <div><input class = "standard h control" type="checkbox" value="h" checked="checked"><span>High</span></div>
  </div>

  <div class = "controlContainer">
    <div>AMT exemption phaseout threshold</div>
    <div><input class = "amtThreshold l control" type="checkbox" value="l" checked="checked"><span>Low</span></div>
    <div><input class = "amtThreshold h control" type="checkbox" value="h" checked="checked"><span>High</span></div>
  </div>

  <div class = "controlContainer">
    <div>AMT exemption amount</div>
    <div><input class = "amtAmount l control" type="checkbox" value="l" checked="checked"><span>Low</span></div>
    <div><input class = "amtAmount h control" type="checkbox" value="h" checked="checked"><span>High</span></div>
  </div>

  <div class = "controlContainer">
    <div>Personal exemption amount</div>
    <div><input class = "personal l control" type="checkbox" value="l" checked="checked"><span>$0</span></div>
    <div><input class = "personal ml control" type="checkbox" value="ml" checked="checked"><span>$991</span></div>
    <div><input class = "personal mh control" type="checkbox" value="mh" checked="checked"><span>$4,150</span></div>
    <div><input class = "personal h control" type="checkbox" value="h" checked="checked"><span>$5,550</span></div>
  </div>

  <div class = "controlContainer">
    <div>State and local tax deduction</div>
    <div><input class = "salt l control" type="checkbox" value="l" checked="checked"><span>$0</span></div>
    <div><input class = "salt ml control" type="checkbox" value="ml" checked="checked"><span>$10,000</span></div>
    <div><input class = "salt mh control" type="checkbox" value="mh" checked="checked"><span>$15,000</span></div>
    <div><input class = "salt h control" type="checkbox" value="h" checked="checked"><span>$20,000</span></div>
  </div>


  <div class = "controlContainer">
    <div>Refundability threshold of child tax credit</div>
    <div><input class = "ctcThreshold l control" type="checkbox" value="l" checked="checked"><span>$0</span></div>
    <div><input class = "ctcThreshold medium control" type="checkbox" value="medium" checked="checked"><span>$1,250</span></div>
    <div><input class = "ctcThreshold h control" type="checkbox" value="h" checked="checked"><span>$2,500</span></div>
  </div>

  <div class = "controlContainer">
    <div>Refunable portion of the child tax credit</div>
    <div><input class = "ctcAmount l control" type="checkbox" value="l" checked="checked"><span>$1,000</span></div>
    <div><input class = "ctcAmount medium control" type="checkbox" value="medium" checked="checked"><span>$1,400</span></div>
    <div><input class = "ctcAmount h control" type="checkbox" value="h" checked="checked"><span>$2,000</span></div>
  </div>


</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="js/jquery-2.2.1.min.js"></script>

<!-- <script src = "js/prototype.js"></script> -->
<script>
// d3.json("data/data.json", function(points){

d3.json("data/data.json", function(points){
  var shown;

  var margin = {top: 20, right: 10, bottom: 30, left: 40},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

  var svg = d3.select("#chartContainer").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + " " + margin.top + ")");

  // var factory = d3.quadtree()
  //   .extent([
  //     [0, 0],
  //     [width, height]
  //   ]);

  var x = d3.scaleLinear()
    .range([0, width]);

  var y = d3.scaleLinear()
    .range([height,0]);

  var xAxis = d3.axisBottom()
    .scale(x)

var f = d3.format("0.2s");

// document.write(
//   f(1e9).replace(/G/,"B")
// );
  var yAxis = d3.axisLeft()
    .scale(y)
    .tickFormat(function(t){
      return f(t).replace(/G/,"B")
    })

  var xg = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + (height * (300/(300+550))) + ")");


  var yg = svg.append("g")
    .attr("class", "y axis")
    .attr("transform", "translate(" + (x(.35) + margin.left - 4) + "," + 0 + ")");;

  var chartArea = d3.select("#chartContainer").append("div")
    .style("left", margin.left + "px")
    .style("top", margin.top + "px")
    .style("position", "absolute")
    // .style("z-index","-1");

  var canvas = chartArea.append("canvas")
    .attr("width", width)
    .attr("height", height);

  var context = canvas.node().getContext("2d");

  

  // Layer on top of canvas, example of selection details
  var highlight = chartArea.append("svg")
    .attr("width", width)
    .attr("height", height)
    .style("position", "absolute")
    .style("left", 9)
    .style("top", 30)
      .append("circle")
        .attr("r", 3)
        .classed("hidden", true);

  function init(){
    points.forEach(function(p,i){
      p.x = p["a1"]
      p.y = p["burden"]
    })
    shown = points.map(function(p){ return [p.x, p.y] })

  }

  function draw() {

    // Randomize the scale
    var scale = 1 + Math.floor(Math.random() * 10);

  // y, -550 to 250
  // x, -2.5, 5.5


    // Redraw axes
    x.domain([-3.50, 5.50]);
    y.domain([-550000000000, 300000000000]);

    // x.domain([-, 1.5]);
    // y.domain([-550, -200]);

    xg.call(xAxis);
    yg.call(yAxis);


    var tree = d3.quadtree()
    .x(function(p){ return x(p.x) })
    .y(function(p){ return y(p.y) })
    .extent([[-1, -1], [width + 1, height + 1]])



    // Update canvas
    context.clearRect(0, 0, width, height);


    points.forEach(function(p,i){

      context.beginPath();
      context.arc(x(p.x), y(p.y), 3, 0, 2 * Math.PI);
      if(p.hide){
         context.fillStyle = "rgba(0, 0, 0, 0.008)";
         context.fill();
      }
    });

    points.forEach(function(p,i){

      context.beginPath();
      context.arc(x(p.x), y(p.y), 3, 0, 2 * Math.PI);
      if(!p.hide){
         context.fillStyle = "rgba(22,150,210, 0.3)";
         context.fill();
         tree.add(p)
      }
    });


  canvas.on("mousemove",function(){

    var mouse = d3.mouse(this),
        closest = tree.find(mouse[0], mouse[1]);
        console.log(closest, mouse)
    // tree.visit(function(node, x0, y0, x1, y1){
    //   // console.log(x0, y0)
    // })
// console.log(x.invert(mouse[0]), y.invert(mouse[1]))
// console.log(closest)
    if(typeof(closest) != "undefined"){
      showExploreTooltip(closest)


    }else{
      hideExploreTooltip()
      
    }

  });

  canvas.on("mouseover",function(){
    highlight.classed("hidden", false);
  });

  canvas.on("mouseout",function(){
    hideExploreTooltip()
  });


  }

  init();


  draw(); 

d3.select("#groupMenu").on("input", function(){
  animateLayout(d3.select("#incomeMenu").node().value, this.value)
})

d3.select("#incomeMenu").on("input", function(){
  animateLayout(this.value, d3.select("#groupMenu").node().value)
})


d3.selectAll(".control")
  .on("input", function(){
    filterPoints(getFilterVals())
  })



const duration = 1000;
const ease = d3.easeCubic;
let timer;

function getFilterVals(){
  var returned = {}
  var filterVars = ["standard", "rates", "amtThreshold", "amtAmount", "personal","salt", "ctcAmount", "ctcThreshold"]
  for(var i = 0; i < filterVars.length; i++){
    var vals = []
    var filterVar = filterVars[i]
    d3.selectAll(".control." + filterVar).each(function(){
      if(this.checked){ vals.push(this.value) }
    })
    returned[filterVar] = vals
  }
  return returned
}

function filterPoints(filters){
  console.log(filters)
  points.forEach(function(point){
    point.hide = false;
    for(var filter in filters){
      if(point.hide){
        continue
      }else{
        if(filters.hasOwnProperty(filter)){
          var vals = filters[filter]
          if(vals.indexOf(point[filter]) == -1){
              point.hide = true
          }else{
            point.hide = false;
          }
        }
      }
    }

  })
  shown = points.filter(function(p){ return p.hide == false })
    .map(function(p){ return [p.x, p.y] })
  draw();

}

function animateLayout(income, group) {
  d3.timerFlush()
  // store the source position
  points.forEach(function(point){
    point.sx = point.x;
  });

  points.forEach(function(point){
    point.tx = point[group + income];
  });

  

  timer = d3.timer(function(elapsed){
    // compute how far through the animation we are (0 to 1)
    const t = Math.min(1, ease(elapsed / duration));

    // update point positions (interpolate between source and target)
    points.forEach(point => {
      point.x = point.sx * (1 - t) + point.tx * t;
    });

    // update what is drawn on screen
    draw();

    // if this animation is over
    if (t === 1) {
      // stop this timer for this layout and start a new one
      shown = points.map(function(p){ return [p.x, p.y] })
      draw();
      timer.stop()

    }
  });
}

function showExploreTooltip(point){
d3.select("#revdisp span").text(d3.format("$.4s")(point.burden).replace(/G/,"B"))

d3.select("#incdisp span").text(point[d3.select("#groupMenu").node().value + d3.select("#incomeMenu").node().value] + "%")



  for(property in point){
    if(point.hasOwnProperty(property)){

      if(d3.select(".control." + property).node() != null){
        console.log(property, point[property])
        d3.selectAll(".control." + property).nodes().forEach(function(n){
          d3.select(n.parentNode).classed("tempHighlight", false)
        })

          
        d3.select(d3.select(".control." + property + "." + point[property]).node().parentNode).classed("tempHighlight", true)
      }
    }
  }
       highlight.classed("hidden", false)
        .attr("cx", x(point.x))
        .attr("cy", y(point.y));
}

function hideExploreTooltip(){
  highlight.classed("hidden", true)
  d3.selectAll(".tempHighlight").classed("tempHighlight", false)
}



})
</script>
</body>